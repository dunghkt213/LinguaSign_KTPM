groups:
  - name: kafka_alerts
    interval: 30s
    rules:
      # Consumer Lag Alert
      - alert: KafkaConsumerLagHigh
        expr: kafka_consumergroup_lag > 1000
        for: 5m
        labels:
          severity: warning
          component: kafka
        annotations:
          summary: "Kafka consumer lag is high"
          description: "Consumer group {{ $labels.consumergroup }} has lag of {{ $value }} messages on topic {{ $labels.topic }}"

      # Critical Consumer Lag
      - alert: KafkaConsumerLagCritical
        expr: kafka_consumergroup_lag > 10000
        for: 2m
        labels:
          severity: critical
          component: kafka
        annotations:
          summary: "Kafka consumer lag is critical"
          description: "Consumer group {{ $labels.consumergroup }} has critical lag of {{ $value }} messages"

      # Under-replicated Partitions
      - alert: KafkaUnderReplicatedPartitions
        expr: kafka_topic_partition_under_replicated_partition > 0
        for: 5m
        labels:
          severity: warning
          component: kafka
        annotations:
          summary: "Kafka has under-replicated partitions"
          description: "Topic {{ $labels.topic }} has {{ $value }} under-replicated partitions"

      # Offline Partitions
      - alert: KafkaOfflinePartitions
        expr: kafka_controller_kafkacontroller_offlinepartitionscount > 0
        for: 1m
        labels:
          severity: critical
          component: kafka
        annotations:
          summary: "Kafka has offline partitions"
          description: "Kafka cluster has {{ $value }} offline partitions"

      # Broker Down
      - alert: KafkaBrokerDown
        expr: up{job="kafka-broker"} == 0
        for: 2m
        labels:
          severity: critical
          component: kafka
        annotations:
          summary: "Kafka broker is down"
          description: "Kafka broker {{ $labels.instance }} is down"

      # High Message Rate
      - alert: KafkaHighMessageInRate
        expr: rate(kafka_server_brokertopicmetrics_messagesin_total[5m]) > 1000
        for: 5m
        labels:
          severity: info
          component: kafka
        annotations:
          summary: "Kafka high message in rate"
          description: "Kafka is receiving {{ $value }} messages/sec"

  - name: service_alerts
    interval: 30s
    rules:
      # Service Down
      - alert: ServiceDown
        expr: up{job=~".*-service"} == 0
        for: 2m
        labels:
          severity: critical
          component: microservice
        annotations:
          summary: "Service is down"
          description: "Service {{ $labels.job }} at {{ $labels.instance }} is down"

      # High Response Time
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: microservice
        annotations:
          summary: "High response time detected"
          description: "Service {{ $labels.job }} has P95 response time of {{ $value }}s"

      # High Error Rate
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          component: microservice
        annotations:
          summary: "High error rate detected"
          description: "Service {{ $labels.job }} has error rate of {{ $value }}"

  - name: database_alerts
    interval: 30s
    rules:
      # MongoDB Connection Issues
      - alert: MongoDBConnectionIssues
        expr: mongodb_connections_current > 1000
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "MongoDB has too many connections"
          description: "MongoDB has {{ $value }} current connections"

      # MongoDB Replication Lag
      - alert: MongoDBReplicationLag
        expr: mongodb_replset_member_replication_lag > 10
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "MongoDB replication lag is high"
          description: "MongoDB replica has {{ $value }}s replication lag"
